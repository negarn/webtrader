define(["jquery","windows/windows","websockets/binary_websockets","jquery-ui","datatables","jquery-growl"],function(a,b,c){"use strict";function d(a){a.click(function(){k?k.moveToTop():g()})}function e(a){var b=a.proposal_open_contract,c=b.contract_id,d=b.bid_price;if(l){var e=l.api().row("#"+c),f=e.data();if(!f)return;var g=f[3];f[3]=d,e.data(f);var h=l.find("#"+c);b.is_valid_to_sell?(h.removeClass("resale-not-offered"),g!==d&&h.removeClass("indicative-red indicative-green").addClass(1*d>1*g?"indicative-green":"indicative-red")):h.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}function f(b){if("subscribe"===b)++p,!o&&p>0&&c.send({proposal_open_contract:1,subscribe:1}).then(function(){o=!0})["catch"](function(b){a.growl.error({message:b.message})});else if("forget"===b)--p,o&&0===p&&c.send({forget_all:"proposal_open_contract"}).then(function(){o=!1})["catch"](function(a){o=!1});else{if("resubscribe"!==b)return;c.send({forget_all:"proposal_open_contract"}).then(function(){o=!1,--p,f("subscribe")})["catch"](function(a){o=!1})}}function g(){require(["css!portfolio/portfolio.css"]),c.send({balance:1}).then(function(d){c.events.on("balance",function(a){void 0!==a.balance&&void 0!==a.balance.currency&&(g=a.balance.currency,m.update(a.balance.balance))}),c.events.on("transaction",function(a){var b=a.transaction;if("buy"===b.action){var c="<button>View</button>".i18n(),d=[b.transaction_id,b.longcode,Math.abs(b.amount),"0.00",c,b.contract_id,b];l.api().rows.add([d]),l.api().draw(),h([b])}else if("sell"===b.action){var e=l.find("#"+b.contract_id)[0];l.api().row(e).remove(),l.api().draw(),i([b])}}),k=b.createBlankWindow(a("<div/>"),{title:"Portfolio".i18n(),width:700,height:400,"data-authorized":"true",close:function(){i(n),c.events.off("proposal_open_contract",e)},open:function(){j(),c.events.on("proposal_open_contract",e)},destroy:function(){l&&l.DataTable().destroy(!0),k=null},refresh:function(){c.send({balance:1})["catch"](function(b){a.growl.error({message:b.message})}),i(n).then(j)}});var f=k.parent().find(".ui-dialog-title").addClass("with-content");m=a('<span class="span-in-dialog-header" />').insertAfter(f),m.update=function(a){m.html("Account balance: <strong>".i18n()+formatPrice(a,g)+"</strong>")};var g=d.balance.currency;l=a("<table width='100%' class='portfolio-dialog hover'/>"),l.appendTo(k),l=l.dataTable({data:[],columns:[{title:"Ref.".i18n()},{title:"Contract Details".i18n()},{title:"Purchase".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,g)+"</span>"}},{title:"Indicative".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,g)+"</span>"}},{title:""}],rowId:"5",paging:!1,ordering:!1,processing:!0}),l.parent().addClass("hide-search-input"),k.on("click",q),k.track({module_id:"portfolio",is_unique:!0,data:null}),k.dialog("open")})["catch"](function(a){})}function h(b){b.forEach(function(b){n.push(b),c.proposal_open_contract.subscribe(b.contract_id)["catch"](function(b){a.growl.error({message:b.message})})})}function i(b){var d=b.map(function(b){return c.proposal_open_contract.forget(b.contract_id)["catch"](function(b){a.growl.error({message:b.message})})}),e=_.map(b,"contract_id");return n=n.filter(function(a){return _.includes(e,a.contract_id)===!1}),Promise.all(d)}function j(){var b=a("#"+l.attr("id")+"_processing").show();c.send({portfolio:1}).then(function(a){var d=a.portfolio&&a.portfolio.contracts,e="<button>View</button>".i18n(),f=d.map(function(a){return[a.transaction_id,a.longcode,a.buy_price,"0.00",e,a.contract_id,a]});d.forEach(function(a){c.sell_expired(a.expiry_time)}),h(d),l.api().rows().remove(),l.api().rows.add(f),l.api().draw(),b.hide()})["catch"](function(c){l.api().rows().remove(),l.api().draw(),b.hide(),a.growl.error({message:c.message})})}var k=null,l=null,m=null,n=[],o=!1,p=0;c.events.on("logout",function(){o=!1,p=0});var q=function(b){var c=b.target,d=a(c);if("BUTTON"===c.tagName&&!d.hasClass("button-disabled")){var e=c.parentElement.parentElement,f=l.api().row(e).data();f=_.last(f),d.addClass("button-disabled"),require(["viewtransaction/viewTransaction"],function(a){a.init(f.contract_id,f.transaction_id).then(function(){d.removeClass("button-disabled")})})}};return{proposal_open_contract:{subscribe:function(){f("subscribe")},forget:function(){f("forget")},resubscribe:function(){f("resubscribe")}},init:d}});