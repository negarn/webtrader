"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["jquery","charts/chartWindow","common/rivetsExtra"],function(a,b,c){require(["text!trade/tradeTemplateManager.html"]),local_storage.get("trade-templates")||local_storage.set("trade-templates",[]);var d=function(){function b(a,d){var e=this;_classCallCheck(this,b);var f=this.init_state(a,d);require(["text!trade/tradeTemplateManager.html"],function(b){a.append(b.i18n()),e.view=c.bind(a[0],f)})}return _createClass(b,[{key:"init_state",value:function(b,c){var d={route:{value:"menu"},menu:{},templates:{array:local_storage.get("trade-templates"),save_as_value:"",rename_tmpl:null,rename_value:"",current:null}},e=d.route,f=d.templates,g=d.menu,h=c.get_template();-1!==_.findIndex(f.array,function(a){return a.name===h.name})&&(f.current=h),e.update=function(a){e.value=a},g.save_as=function(){var a=c.get_template();a.name=a.categories_value+" "+_.capitalize(a.categoriy_displays_selected),f.save_as_value=a.name,e.update("save-as")},g.templates=function(){f.array=local_storage.get("trade-templates"),e.update("templates")},g.save_changes=function(){var b=c.get_template(),d=b.name,e=local_storage.get("trade-templates"),g=_.findIndex(e,function(a){return a.name===d});-1!==g?e[g]=b:e.push(b),local_storage.set("trade-templates",e),f.array=e,f.current=b,a.growl.notice({message:a("<div/>").text("Template changes saved ".i18n()+"("+b.name+")").html()})},g.open_file_selector=function(){a(b).find("input[type=file]").click()},g.upload=function(b){var c=b.target.files[0];if(c){var d=new FileReader;d.onload=function(b){var c=b.target.result,d=null;try{d=JSON.parse(c);var e=d.random,g=d.template_type;if(delete d.random,e!==i(JSON.stringify(d)))throw new UserException("InvalidHash");if(delete d.template_type,"trade-template"!==g)return void a.growl.error({message:"Invalid template type.".i18n()})}catch(b){return void a.growl.error({message:"Invalid json file.".i18n()})}f.apply(d);for(var h=local_storage.get("trade-templates"),j=!1,k=1,l=d.name;!j;)h.map(function(a){return a.name}).includes(l)?(l=d.name+" ("+k+")",k++):(d.name=l,j=!0);h.push(d),local_storage.set("trade-templates",h),f.array=h,a.growl.notice({message:"Successfully applied the template and saved it as ".i18n()+"<b>"+d.name+"</b>"})},d.readAsText(c)}},f.save_as=function(b){b.preventDefault();var d=f.save_as_value.substring(0,20),g=c.get_template();if(g){g.name=d;var h=local_storage.get("trade-templates");if(h.map(function(a){return a.name}).includes(d))return void a.growl.error({message:"Template name already exists".i18n()});h.push(g),f.current=g,local_storage.set("trade-templates",h),f.array=h,e.update("menu"),c.set_template(g)}},f.download=function(b){b.template_type="trade-template",b.random=i(JSON.stringify(b));var c=JSON.stringify(b);download_file_in_browser(b.name+".json","text/json;charset=utf-8;",c),a.growl.notice({message:"Downloading template as <b>".i18n()+b.name+".json</b>"})},f.remove=function(a){var b=local_storage.get("trade-templates");f.array=b.filter(function(b){return b.name!==a.name}),local_storage.set("trade-templates",f.array),f.current&&a.name===f.current.name&&(f.current=null)},f.rename=function(a){f.rename_value=a.name,f.rename_tmpl=a,e.update("rename")},f.do_rename=function(b){b.preventDefault();var d=f.rename_tmpl.name,g=f.rename_value.substring(0,20),h=local_storage.get("trade-templates");if(h.map(function(a){return a.name}).includes(g))return void a.growl.error({message:"Template name already exists".i18n()});var i=h.find(function(a){return a.name===d});if(i){i.name=g,local_storage.set("trade-templates",h),f.array=h,e.update("templates");var j=c.get_template();j.name==d&&(f.current=j,j.name=g,c.set_template(j))}},f.apply=function(a){c.set_template(a),f.current=a,e.update("menu"),c.hide_template_menu()},f.confirm=function(a,b){if(f.current){e.update("confirm");var c=b.currentTarget.text;f.confirm_prevMenu=c==="Delete".i18n()?"templates":"menu",f.confirm_text=c==="Delete".i18n()?"Are you sure you want to delete template?".i18n():"Are you sure you want to overwrite current template?".i18n(),f.confirm_yes=function(){c==="Delete".i18n()?(f.remove(a),f.current===a&&(f.current=null)):g.save_changes(),f.confirm_no()},f.confirm_no=function(){e.update(f.confirm_prevMenu)}}};var i=function(a){return a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)};return d}},{key:"unbind",value:function(){this.view&&this.view.unbind(),this.view=null}}]),b}();return{init:function(a,b){return new d(a,b)}}});