define(["websockets/binary_websockets","charts/chartingRequestMap","jquery","jquery-growl","common/util"],function(a,b,c){function d(a,b,c,d,f,g){var h=e.chain().find({time:b}).find({instrumentCdAndTp:a}).limit(1).data();h&&h.length>0?(h=h[0],h.open=c,h.high=d,h.low=f,h.close=g,e.update(h)):e.insert({instrumentCdAndTp:a,time:b,open:c,high:d,low:f,close:g})}var e=b.barsTable;return a.events.on("candles",function(a){var c=(a.echo_req.ticks_history+a.echo_req.granularity).toUpperCase();for(var e in a.candles){var f=a.candles[e],g=parseFloat(f.open),h=parseFloat(f.high),i=parseFloat(f.low),j=parseFloat(f.close),k=1e3*parseInt(f.epoch);d(c,k,g,h,i,j)}b.barsLoaded(c)}),a.events.on("history",function(a){var c=(a.echo_req.ticks_history+"0").toUpperCase();for(var e in a.history.times){var f=1e3*parseInt(a.history.times[e]),g=parseFloat(a.history.prices[e]);d(c,f,g,g,g,g)}b.barsLoaded(c)}),{retrieveChartDataAndRender:function(d){var f=d.timePeriod,g=d.instrumentCode,h=d.containerIDWithHash,i=d.instrumentName,j=d.series_compare,k=b.keyFor(g,f);if(b[k])return b.subscribe(k,{containerIDWithHash:h,series_compare:j,instrumentCode:g,instrumentName:i}),b.barsLoaded(k),Promise.resolve();var l=b.register({symbol:g,granularity:f,subscribe:0===d.delayAmount?1:0,style:isTick(f)?"ticks":"candles",count:1e3,adjust_start_time:1})["catch"](function(a){var b="Error getting data for %1".i18n().replace("%1",i);require(["jquery","jquery-growl"],function(a){a.growl.error({message:b})});var d=c(h).highcharts();d&&d.showLoading(b)}).then(function(h){h&&!h.error&&d.delayAmount>0&&(require(["jquery-growl"],function(){c.growl.warning({message:i+" feed is delayed by ".i18n()+d.delayAmount+" minutes".i18n()})}),b[k].timerHandler=setInterval(function(){var b=e.chain().find({instrumentCdAndTp:k}).simplesort("time",!0).limit(1).data();if(b&&b.length>0){b=b[0];var c={ticks_history:g,end:"latest",start:b.time/1e3|0,granularity:convertToTimeperiodObject(f).timeInSeconds()};a.send(c)}},6e4))});return b[k].chartIDs.push({containerIDWithHash:h,series_compare:j,instrumentCode:g,instrumentName:i}),l}}});