define(["jquery","windows/windows","websockets/binary_websockets","lodash","common/rivetsExtra","moment","text!selfexclusion/selfexclusion.html","jquery-growl","common/util"],function(a,b,c,d,e,f,g){function h(){m.exclude_until&&f.utc(m.exclude_until,"YYYY-MM-DD").isAfter(f.utc().startOf("day"))&&d.defer(function(){a.growl.error({message:"You have excluded yourself until ".i18n()+m.exclude_until}),c.invalidate()}),m.timeout_until&&f(m.timeout_until).isAfter(f().unix().valueOf())&&(a.growl.error({message:"You have excluded yourself until ".i18n()+f.unix(m.timeout_until).utc().format("YYYY-MM-DD HH:mm")+"GMT"}),c.invalidate())}var i=null,j=null,k=null,l={max_balance:{limit:1e19,set:!1,name:"Maximum balance"},max_turnover:{limit:1e20,set:!1,name:"Daily turnover limit"},max_losses:{limit:1e20,set:!1,name:"Daily limit on losses"},max_7day_turnover:{limit:1e20,set:!1,name:"7-day turnover limit"},max_7day_losses:{limit:1e20,set:!1,name:"7-day limit on losses"},max_30day_turnover:{limit:1e20,set:!1,name:"30-day turnover limit"},max_30day_losses:{limit:1e20,set:!1,name:"30-day limit on losses"},max_open_bets:{limit:101,set:!1,name:"Maximum open positions"},session_duration_limit:{limit:60480,set:!1,name:"Session duration limit"},exclude_until:{limit:null,set:!1,name:"Exclude time"},timeout_until:{limit:null,set:!1,name:"Time out until"}},m={max_balance:null,max_turnover:null,max_losses:null,max_7day_turnover:null,max_7day_losses:null,max_30day_turnover:null,max_30day_losses:null,max_open_bets:null,session_duration_limit:null,exclude_until:null,timeout_until_date:null,timeout_until_time:null,update:function(b,d){var e={set_self_exclusion:1},g=!0;if(d.timeout_until_date&&d.timeout_until_time){var i=f(d.timeout_until_date+" "+d.timeout_until_time,"YYYY-MM-DD hh:mm");i.isAfter(f().add(6,"weeks"))&&(g=!1,a.growl.error({message:"Please enter a value less than 6 weeks for time out until."})),d.timeout_until=i.unix().valueOf()}else(d.timeout_until_date||d.timeout_until_time)&&(g=!1,a.growl.error({message:"Please enter both date and time for Time out until."}));a.each(l,function(b,c){if(d[b]||c.set){if("exclude_until"===b&&f.utc(d.exclude_until,"YYYY-MM-DD").isBefore(f.utc().startOf("day").add(6,"months"))){var h="Exclude until time cannot be less than 6 months.";return g=!1,void a.growl.error({message:h})}if(!d[b]||d[b]<=0||c.limit&&d[b]>c.limit){var h="Please enter a value between 0 and "+c.limit+" for "+c.name;return g=!1,void a.growl.error({message:h})}e[b]=d[b]}}),g&&c.send(e).then(function(){a.growl.notice({message:"Your changes have been updated".i18n()}),h(),p()})["catch"](function(b){a.growl.error({message:b.message})})}},n=function(){return require(["css!selfexclusion/selfexclusion.css"]),new Promise(function(c){var d=a(g).i18n();d.find(".datepicker").datepicker({dateFormat:"yy-mm-dd",minDate:f.utc().toDate(),maxDate:f.utc().add(6,"weeks").toDate()}),d.find(".timepicker").timepicker({timeFormat:"HH:MM"}),i=b.createBlankWindow(a("<div/>"),{title:"Self-Exclusion Facilities".i18n(),width:900,minHeight:500,height:500,"data-authorized":"true",destroy:function(){i=null}}),d.appendTo(i),e.bind(d[0],m),o(),c()})},o=function(){return a.growl.notice({message:"Loading self-exclusion settings.".i18n()}),c.send({get_self_exclusion:1}).then(function(b){b.get_self_exclusion&&(a.each(l,function(a){m[a]=b.get_self_exclusion[a],b.get_self_exclusion[a]&&(l[a].limit=b.get_self_exclusion[a],l[a].set=!0)}),h())})["catch"](function(b){a.growl.error({message:b.message})})},p=function(){if(!d.isUndefined(m.session_duration_limit)&&!d.isNull(m.session_duration_limit)&&d.isFinite(d.toNumber(m.session_duration_limit))){j&&clearTimeout(j);var b=60*m.session_duration_limit*1e3;b-=d.now()-k,b>Math.pow(2,32)&&(b=Math.pow(2,32)),j=setTimeout(function(){a.growl.warning({message:"Logging out because of self-exclusion session time out!".i18n()}),c.invalidate()},b)}},q=function(){i&&i.dialog("destroy"),i=null,j&&clearTimeout(j),j=null,k=null,m.max_balance=null,m.max_turnover=null,m.max_losses=null,m.max_7day_turnover=null,m.max_7day_losses=null,m.max_30day_turnover=null,m.max_30day_losses=null,m.max_open_bets=null,m.session_duration_limit=null,m.exclude_until=null,a("#nav-container a.selfexclusion").addClass("disabled")};return c.events.on("login",function(){c.cached.authorize().then(function(b){b.authorize.is_virtual?q():(k=d.now(),o().then(function(){p()}),a("#nav-container a.selfexclusion").removeClass("disabled"))})["catch"](function(){q()})}),c.events.on("logout",q),{init:function(b){b.click(function(){a(this).hasClass("disabled")||c.cached.authorize().then(function(){i?(o(),i.moveToTop()):n().then(function(){i.dialog("open")})})["catch"](function(a){})})}}});