define(["websockets/binary_websockets","windows/windows","common/rivetsExtra","lodash"],function(a,b,c,d){function e(){return g?void g.moveToTop():void require(["text!oauth/login.html","css!oauth/login.css"],function(a){a=$(a).i18n(),g=b.createBlankWindow(a,{title:"Log in",resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,width:548,height:180,"data-authorized":!0,close:function(){g.dialog("destroy"),g.remove(),g=null},open:function(){},destroy:function(){h&&h.unbind(),h=null}}),g.parent().css("overflow","visible"),f(a),g.dialog("open");var c=g.dialog("widget").offset();c.top=120,g.dialog("option","position",{my:c.left,at:c.top}),g.dialog("widget").css({left:c.left+"px",top:c.top+"px"}),g.dialog("widget").find(".ui-selectmenu-menu ul").css("max-height","320px")})}function f(b){var e=a.app_id,f={route:{value:"login"},login:{disabled:!1},registration:{email:"",disabled:!1,validate:{value:!1},email_show_explanation:function(){var a=f.registration.email;return""===a&&!f.registration.validate.value||validateEmail(a)}},account:{empty_fields:{validate:!1,clear:d.debounce(function(){f.account.empty_fields.validate=!1},2e3),show:function(){f.account.empty_fields.validate=!0,f.account.empty_fields.clear()}},password_error_message:function(){var a=f.account.password;return""===a?f.account.empty_fields.validate?"* Please enter your password".i18n():"":a.length<6?"* Password must be 6 characters minimum".i18n():/\d/.test(a)&&/[a-z]/.test(a)&&/[A-Z]/.test(a)?"":"* Password must contain lower and uppercase letters with numbers".i18n()},verification:"",password:"",repeat_password:"",residence:"af",residence_list:[{text:"Afghanistan",value:"af"}],residence_unsupported:["cr","gg","hk","ir","iq","jp","je","kp","my","mt","us","um","vi"],disabled:!1},confirm:{disabled:!1}};f.login.login=function(){f.login.disabled=!0;var a=local_storage.get("config"),b=a&&a.oauth_url||"https://oauth.binary.com/oauth2/authorize";window.location=b+"?app_id="+e+"&scope=read,trade,payments,admin"},f.confirm.confirm=function(){f.confirm.disabled=!0;var a=local_storage.get("config"),b=a&&a.oauth_url||"https://oauth.binary.com/oauth2/authorize";window.location=b+"?app_id="+e+"&scope=read,trade,payments,admin"},f.route.update=function(a){var b={login:{title:"Log in".i18n(),height:180},registration:{title:"Registration".i18n(),height:220},account:{title:"Account opening".i18n(),height:465},confirm:{title:"Account opening".i18n(),height:415}};f.route.value=a;var c=b[a].title,d=b[a].height;g.dialog("option","title",c),g.dialog("option","height",d)},f.registration.validate.clear=d.debounce(function(){f.registration.validate.value=!1},2e3),f.registration.validate.show=function(){f.registration.validate.value=!0,f.registration.validate.clear()},f.registration.create=function(){var b=f.registration.email;return""!=b&&validateEmail(b)?(f.registration.disabled=!0,void a.send({verify_email:b,type:"account_opening"}).then(function(a){if(f.registration.disabled=!1,!a.verify_email)throw{message:"Email verification failed (".i18n()+a.msg_type+")"};$.growl.notice({message:"Verification code sent to ".i18n()+b}),f.route.update("account")})["catch"](function(a){$.growl.error({message:a.message}),f.registration.disabled=!1})):void f.registration.validate.show()},f.account.open=function(){f.account.empty_fields.show();var b=f.registration.email,c=f.account.verification,d=f.account.password,e=f.account.repeat_password,g=f.account.residence,h=validateEmail(b)&&""!==c&&d===e&&d.length>=6;if(h=h&&/\d/.test(d)&&/[a-z]/.test(d)&&/[A-Z]/.test(d)&&2===g.length){var i={new_account_virtual:1,verification_code:c,client_password:d,residence:g};f.account.disabled=!0,a.send(i).then(function(a){var b=a.new_account_virtual,c=[{id:b.client_id,token:b.oauth_token}];local_storage.set("oauth",c),f.account.disabled=!1,f.route.update("confirm")})["catch"](function(a){$.growl.error({message:a.message}),f.account.disabled=!1})}},h=c.bind(b[0],f),a.cached.send({residence_list:1}).then(function(b){f.account.residence_list=b.residence_list.map(function(a){return a.disabled=-1!==f.account.residence_unsupported.indexOf(a.value),a}),f.account.residence=b.residence_list[0].value,a.cached.send({website_status:1}).then(function(a){var b=a.website_status&&a.website_status.clients_country;-1===f.account.residence_unsupported.indexOf(b)&&(f.account.residence=b||"id")})["catch"](function(a){f.account.residence="id"})})["catch"](function(a){$.growl.error({message:a.message})})}var g=null,h=null;return{init:e,login:function(){var b=a.app_id,c=local_storage.get("config"),d=c&&c.oauth_url||"https://oauth.binary.com/oauth2/authorize";window.location=d+"?app_id="+b+"&scope=read,trade,payments,admin"}}});