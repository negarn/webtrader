define(["jquery","navigation/navigation","lodash","common/util"],function(a,b,c){"use strict";function d(b,c,e){c.forEach(function(c){var f=c.submarkets||c.instruments,g="<span class='nav-submenu-caret'></span>",h=f?c.display_name+g:c.display_name,i=a("<a href='#'>"+h+"</a>");c.is_disabled&&i.addClass("disabled");var j=a("<li>").append(i);if(f||j.data(c),j.appendTo(b),f){var k=a("<ul>").addClass("primary-color");k.appendTo(j),d(k,c.submarkets||c.instruments,e)}else e&&!c.is_disabled&&i.click(function(){var b=a(this).parent();e(b)})})}return{extractChartableMarkets:function(a){return this.extractFilteredMarkets(a,{filter:function(a){return"chartonly"!==a.feed_license}})||[]},extractFilteredMarkets:function(a,b){var c=a.trading_times.markets.map(function(a){var c={name:a.name,display_name:a.name};return c.submarkets=a.submarkets.map(function(a){var c={name:a.name,display_name:a.name},d=a.symbols;return b&&b.filter&&(d=d.filter(b.filter)),c.instruments=d.map(function(a){return{symbol:a.symbol,display_name:a.name,delay_amount:a.delay_amount||0,events:a.events,times:a.times,settlement:a.settlement,feed_license:a.feed_license||"realtime"}}),c}).filter(function(a){return a.instruments.length>0}),c});return c},sortMenu:function(b){var d=sortAlphaNum("display_name");if(a.isArray(b)){var e={forex:1,indices:2,stocks:3,commodities:4,volidx:5};b=c.sortBy(b,function(a){return e[a.name.toLowerCase()]}),b.forEach(function(b){a.isArray(b.submarkets)&&(b.submarkets.sort(d),b.submarkets.forEach(function(b){a.isArray(b.instruments)&&b.instruments.sort(d)}))})}return b},refreshMenu:function(a,c,e){d(a,c,e),b.updateDropdownToggles()}}});