define(["jquery","websockets/binary_websockets","charts/chartingRequestMap","common/util"],function(a,b,c){function d(a,b,c){a.xAxis.forEach(function(a){b||(b=a.getExtremes().min),c||(c=a.getExtremes().max),a.setExtremes(b,c)})}var e=c.barsTable;b.events.on("tick",function(b){var d=b.echo_req.ticks_history+b.echo_req.granularity;if(d&&c[d.toUpperCase()]){d=d.toUpperCase();var f=parseFloat(b.tick.quote),h=1e3*parseInt(b.tick.epoch),i=c[d],j=b.echo_req.granularity||0;if(i.id=i.id||b.tick.id,0===j){var k={instrumentCdAndTp:d,time:h,open:f,high:f,low:f,close:f,price:b.tick.quote};e.insert(k);var l=k,m=e.chain().find({instrumentCdAndTp:d}).simplesort("time",!0).limit(2).data();if(m.length>1&&(l=m[1]),g("tick",{tick:k,key:d,preTick:l}),!(i.chartIDs&&i.chartIDs.length>0))return;i.chartIDs.forEach(function(b){var c=a(b.containerIDWithHash).highcharts();if(c){var e=c.get(d);e&&e.addPoint([h,f])}})}}}),b.events.on("ohlc",function(b){var f=b.ohlc.symbol+b.ohlc.granularity;if(f&&c[f.toUpperCase()]){f=f.toUpperCase(),a(document).trigger("feedTypeNotification",[f,"realtime-feed"]);var h=parseFloat(b.ohlc.open),i=parseFloat(b.ohlc.high),j=parseFloat(b.ohlc.low),k=parseFloat(b.ohlc.close),l=1e3*parseInt(b.ohlc.open_time),m=c[f];if(m.id=m.id||b.ohlc.id,!(m.chartIDs&&m.chartIDs.length>0))return;var n=a(m.chartIDs[0].containerIDWithHash).data("timePeriod");if(!n)return;var o=e.chain().find({$and:[{instrumentCdAndTp:f},{time:l}]}).simplesort("time",!0).limit(1).data(),p=!1;!o||o.length<=0?(o={instrumentCdAndTp:f,time:l,open:h,high:i,low:j,close:k},e.insert(o),p=!0):(o=o[0],o.open=h,o.high=i,o.low=j,o.close=k,e.update(o));var q=o,r=e.chain().find({instrumentCdAndTp:f}).simplesort("time",!0).limit(2).data();r.length>1&&(q=r[1]),g("ohlc",{ohlc:o,is_new:p,key:f,preOhlc:q}),m.chartIDs.forEach(function(b){var c=a(b.containerIDWithHash).highcharts();if(c){var e=c.get(f);if(e){var g=a(b.containerIDWithHash).data("type"),m=e.data[e.data.length-1];return e.options.data.length!=e.data.length?void d(c,null,o.time):void(g&&isDataTypeClosePriceOnly(g)?p?e.addPoint([l,k],!0,!0,!1):m.update({y:k}):p?e.addPoint([l,h,i,j,k],!0,!0,!1):m.update({open:h,high:i,low:j,close:k}))}}})}});var f={},g=function(a){var b=[].slice.call(arguments,1),c=f[a]||[];c.forEach(function(a){setTimeout(function(){a.apply(void 0,b)},0)})};return{events:{on:function(a,b){return(f[a]=f[a]||[]).push(b),b},off:function(a,b){if(f[a]){var c=f[a].indexOf(b);-1!==c&&f[a].splice(c,1)}}}}});