define(["lokijs","lodash","jquery","websockets/binary_websockets","jquery-growl","common/util"],function(a,b,c,d){function e(a){var b=a;if(this[b]&&this[b].chartIDs){var d=this[b].chartIDs,e=this.processOHLC;d.forEach(function(a){if(a){var d=c(a.containerIDWithHash).highcharts().get(b),f=c(a.containerIDWithHash).data("type"),h=c(a.containerIDWithHash).data("timePeriod");if(d){var i=d.data[d.data.length-1].x||d.data[d.data.length-1].time,j=g.chain().find({instrumentCdAndTp:b}).where(function(a){return a.time>=i}).simplesort("time",!1).data();for(var k in j){for(var l=j[k],m=void 0,n=d.data.length-1;n>=0;n--){var o=d.data[n];if(o&&l.time==(o.x||o.time)){m=o;break}}m?f&&isDataTypeClosePriceOnly(f)?m.update([l.time,l.close],!1):m.update([l.time,l.open,l.high,l.low,l.close],!1):f&&isDataTypeClosePriceOnly(f)?d.addPoint([l.time,l.close],!1,!0):d.addPoint([l.time,l.open,l.high,l.low,l.close],!1,!0)}d.isDirty=!0,d.isDirtyData=!0,d.chart.redraw()}else{var p=c(a.containerIDWithHash).highcharts(),q=[],j=g.chain().find({instrumentCdAndTp:b}).simplesort("time",!1).data();for(var r in j)e(j[r].open,j[r].high,j[r].low,j[r].close,j[r].time,f,q);if(!p||0===q.length)return;var s=30;isTick(h)&&(s=200);var t=q.length,u=q.length>s?t-s:0,v=a.instrumentName,w=a.series_compare,x=0;p.series.forEach(function(a){a.options.isInstrument&&"navigator"!==a.options.id&&++x}),0===x&&(p.xAxis[0].range=q[t-1][0]-q[u][0]);var y={id:b,name:v,data:q,type:f?f:"candlestick",dataGrouping:{enabled:!1},compare:w,states:{hover:{enabled:!1}},isInstrument:!0};(isLineDotType(f)||isDotType(f))&&(y.type="line",isDotType(f)&&(y.dashStyle="dot"),y.marker={enabled:!isDotType(f),radius:4}),p.addSeries(y)}}})}}var f=new a,g=f.addCollection("bars_table");return{barsTable:g,processOHLC:function(a,b,d,e,f,g,h){if(!(h.length>0&&h[h.length-1][0]>f))if(g&&isDataTypeClosePriceOnly(g)){if(!c.isNumeric(f)||!c.isNumeric(e))return;h.push([f,e])}else{if(!(c.isNumeric(f)&&c.isNumeric(a)&&c.isNumeric(b)&&c.isNumeric(d)&&c.isNumeric(e)))return;h.push([f,a,b,d,e])}},barsLoaded:e,keyFor:function(a,b){var c=b||0;return"string"==typeof c&&(c=convertToTimeperiodObject(c).timeInSeconds()),(a+c).toUpperCase()},register:function(a){var b=this,e=b.keyFor(a.symbol,a.granularity),f=a.granularity||0,g=a.style||"ticks",h=!0;"string"==typeof f&&("0"===c.trim(f)||("1t"===c.trim(f).toLowerCase()?f=convertToTimeperiodObject(f).timeInSeconds():(h=!1,f=convertToTimeperiodObject(f).timeInSeconds())));var i={ticks_history:a.symbol,granularity:f,count:a.count||1,end:"latest",style:g};if(1===a.subscribe&&(i.subscribe=1),!h){var j=a.count||1,k=(new Date).getTime()/1e3-j*f|0,l=new Date;l.setUTCFullYear(l.getUTCFullYear()-3),l.setDate(l.getDate()+1),1e3*k<l.getTime()&&(k=l.getTime()/1e3|0),i.style="candles",i.start=k,i.adjust_start_time=a.adjust_start_time||1}return b[e]={symbol:a.symbol,granularity:f,subscribers:0,chartIDs:[]},i.subscribe&&(b[e].subscribers=1),d.send(i,3e4)["catch"](function(f){if(i.subscribe&&"MarketIsClosed"==f.code)return c.growl.notice({message:a.symbol+" market is presently closed.".i18n()}),delete i.subscribe,b[e].subscribers-=1,d.send(i,3e4);throw delete b[e],f})},subscribe:function(a,b){var c=this;c[a]&&(c[a].subscribers+=1,b&&c[a].chartIDs.push(b))},unregister:function(a,c){var e=this;e[a]&&(c&&b.remove(e[a].chartIDs,{containerIDWithHash:c}),e[a].subscribers-=1,0===e[a].chartIDs.length&&e[a].timerHandler&&(clearInterval(e[a].timerHandler),e[a].timerHandler=null),0===e[a].subscribers&&e[a].id&&d.send({forget:e[a].id})["catch"](function(a){}),0===e[a].subscribers&&delete e[a])},removeChart:function(a,c){var d=this;d[a]&&b(d[a].chartIDs).map("containerIDWithHash").includes(c)&&(d[a].subscribers-=1,b.remove(d[a].chartIDs,{containerIDWithHash:c}))},digits_after_decimal:function(a,b){if(a=a&&a+"",!a){var c=this.keyFor(b,0),d=0;return g.chain().find({instrumentCdAndTp:c}).simplesort("time",!0).limit(10).data().forEach(function(a){var b=a.close+"",c=b.substring(b.indexOf(".")+1).length;c>d&&(d=c)}),d}return a.substring(a.indexOf(".")+1).length}}});