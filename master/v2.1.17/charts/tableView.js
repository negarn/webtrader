define(["jquery","moment","lokijs","charts/chartingRequestMap","websockets/stream_handler","datatables"],function(a,b,c,d,e){function f(a,c){var d=[{title:"Date",orderable:!1,render:function(a){return b.utc(a).utcOffset(c).format("YYYY-MM-DD HH:mm:ss")}},{title:"Open",orderable:!1},{title:"High",orderable:!1},{title:"Low",orderable:!1},{title:"Close",orderable:!1},{title:"Change",orderable:!1},{title:"",orderable:!1}],e=[0,1,2,3,4,5];return a&&(d=[{title:"Date",orderable:!1,render:function(a){return b.utc(a).utcOffset(c).format("YYYY-MM-DD HH:mm:ss")}},{title:"Tick",orderable:!1},{title:"Change",orderable:!1},{title:"",orderable:!1}],e=[0,1,2]),{columns:d,columnIndexes:e}}function g(b,c){c=c?-1*c:0;var g=b.find(".table-view"),h=b.find("#"+b.attr("id")+"_chart").data(),k=isTick(h.timePeriod),m=b.find("span.close");m.on("click",j.bind(null,b));var n=a("<table class='portfolio-dialog hover'/>");n.appendTo(g);var o=f(k,c);n=n.dataTable({data:[],columns:o.columns,paging:!1,ordering:!0,info:!1,order:[0,"desc"],columnDefs:[{className:"dt-head-center dt-body-center",targets:o.columnIndexes}]}),n.parent().addClass("hide-search-input");var p=e.events.on("tick",function(a){if(a.key===d.keyFor(h.instrumentCode,h.timePeriod)&&b.view_table_visible){var c=a.tick,e=l(a.preTick.open,c.open),f=[c.time,c.open,e.value,e.image];n.api().row.add(f),n.api().draw()}}),q=e.events.on("ohlc",function(a){if(a.key===d.keyFor(h.instrumentCode,h.timePeriod)&&b.view_table_visible){var c=a.ohlc,e=l(a.preOhlc.close,c.close),f=[c.time,c.open,c.high,c.low,c.close,e.value,e.image];if(a.is_new)n.api().row.add(f);else{var g=n.api().rows()[0][0];n.api().row(g).data(f)}n.api().draw()}});return b.on("dialogdestroy",function(){e.events.off("tick",p),e.events.off("ohlc",q)}),{show:i.bind(null,b,h.instrumentCode,c),hide:j.bind(null,b)}}var h=d.barsTable,i=function(a,b,c){var d=a.find(".table-view"),e=a.find(".chart-view");a.find("span.close").css("display","block"),d.animate({left:"0"},250),e.animate({left:"-100%"},250),k(a,b,c);var f=d.find("table").DataTable();f.columns.adjust().draw(),a.view_table_visible=!0},j=function(a){var b=a.find(".table-view"),c=a.find(".chart-view");a.find("span.close").css("display","none"),b.animate({left:"100%"},250),c.animate({left:"0"},250),a.view_table_visible=!1},k=function(a,b,c){var e=a.find("#"+a.attr("id")+"_chart").data(),g=isTick(e.timePeriod),i=a.find(".table-view"),j=h.chain().find({instrumentCdAndTp:d.keyFor(b,e.timePeriod)}).simplesort("time",!0).limit(100).data(),k=0,m=j.map(function(a){var b=k==j.length-1?j[k]:j[k+1];if(k++,g){var c=l(b.open,a.open);return[a.time,a.open,c.value,c.image]}var c=l(b.close,a.close);return[a.time,a.open,a.high,a.low,a.close,c.value,c.image]}),n=i.find("table").DataTable();n.rows().remove(),n.destroy(),i.find("table *").remove();var o=f(g,c);i.find("table").dataTable({data:[],columns:o.columns,paging:!1,ordering:!0,info:!1,order:[0,"desc"],columnDefs:[{className:"dt-head-center dt-body-center",targets:o.columnIndexes}]}).parent().addClass("hide-search-input"),n=i.find("table").DataTable(),n.rows.add(m),n.draw()},l=function(a,b){var c=toFixed(Math.abs(a-b),4),d=toFixed(Math.abs(a-b)/Math.abs(a)*100,2);return b>=a?{value:c+"("+d+"%)",image:0===c?"":'<img src="images/blue_up_arrow.svg" class="arrow-images"/>'}:{value:'<span style="color:brown">'+c+"("+d+"%) </span>",image:0===c?"":'<img src="images/orange_down_arrow.svg" class="arrow-images"/>'}};return{init:g}});