define(["jquery","common/rivetsExtra","lodash","charts/chartWindow","charts/charts","moment","charts/chartingRequestMap","common/util"],function(a,b,c,d,e,f,g){function h(a){a.showTimePeriodSelector=!1,a.toggleLoadSaveSelector(null,a),a.toggleChartTypeSelector(null,a),a.toggleDrawingToolSelector(null,a),a.toggleExportSelector(null,a)}function i(b,c){"table"==c?(o[b.newTabId].showChartTypeSelector=!1,b.tableViewCallback&&b.tableViewCallback()):(o[b.newTabId].chartType=u.filter(function(a){return a.value==c})[0],o[b.newTabId].showChartTypeSelector=!1,e.refresh("#"+b.newTabId+"_chart",null,c),a("#"+b.newTabId).trigger("chart-type-changed",c)),h(b)}function j(b){var c=!1,d=a(b).highcharts();return d&&d.series.forEach(function(a){"percent"===a.options.compare&&(c=!0)}),c}function k(a,b){b?(o[a].chartTypes=u,o[a].chartTypes[1].showBorder=!0):o[a].chartTypes=u.filter(function(a){return"candlestick"!==a.value&&"ohlc"!==a.value})}function l(b,c){var d=c.find(".loadSaveOverlay"),e=c.find(".exportOverlay"),f=c.find(".timeperiod"),g=c.find(".chart_type");c.find(".chartTypeOverlay").css("width",r.ct+53+"px");var h=c.find(".shareButton"),i=420+(r.tp.max+r.ct+65-184);isAffiliates()&&(a(window).width()>i+r.inst?(a(a("#"+b.newTabId+" .chartOptions .table")[0]).css("margin","5px 0px"),a(a("#"+b.newTabId+" .chartOptions .table")[0]).css("float","left"),a("#"+b.newTabId+" .chartOptions .instrument_name"),b.showInstrumentName=!0,a("#"+b.newTabId+"_chart").highcharts().setTitle({text:""})):(a(a("#"+b.newTabId+" .chartOptions .table")[0]).css("margin","5px auto"),a(a("#"+b.newTabId+" .chartOptions .table")[0]).css("float",""),b.showInstrumentName=!1,a("#"+b.newTabId+"_chart").highcharts().setTitle({text:b.instrumentName}))),c.width()>i?(b.showChartTypeLabel=!0,b.timePeriod_name=b.timePeriod.name,f.css("width",r.tp.max+25+"px"),g.css("width",r.ct+55+"px")):(b.showChartTypeLabel=!1,b.timePeriod_name="en"==i18n_name?b.timePeriod.value.toUpperCase():b.timePeriod.value.i18n(),f.css("width",r.tp.min+27+"px"),g.css("width","45px"));var j=c.width()-(h.offset().left+h.outerWidth()-c.offset().left);c.width()<=730?(j=j>0?j:25,e.css("right",j+"px"),d.css("right",j+35+"px")):(d.css("right","auto"),e.css("right","auto"))}function m(b){var c=t.reduce(function(a,b){return a.value.i18n().length>b.value.i18n().length?a:b}),d=t.reduce(function(a,b){return a.name.i18n().length>b.name.i18n().length?a:b}),e=u.reduce(function(a,b){return a.name.i18n().length>b.name.i18n().length?a:b}),f=function(b){var c="0.8em roboto,sans-serif",d=a("<div>"+b.i18n()+"</div>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden",font:c}).appendTo(a("body")),e=d.width();return d.remove(),e};r.tp={},r.tp.min=f(c.value),r.tp.max=f(d.name),r.ct=f(e.name),r.inst=f(b)+20}function n(b,c){b=a(b);var d=b.attr("class");b.toggleClass(d);var e=d.split("-")[0];d=c===!0?e+"-w-icon":e+"-icon",b.toggleClass(d)}var o=[],p=[],q={},r={},s=!1,t=[{value:"1t",name:"1 Tick",digit:1,type:"ticks"},{value:"1m",name:"1 Minute",digit:1,type:"minutes"},{value:"2m",name:"2 Minutes",digit:2,type:"minutes"},{value:"3m",name:"3 Minutes",digit:3,type:"minutes"},{value:"5m",name:"5 Minutes",digit:5,type:"minutes"},{value:"10m",name:"10 Minutes",digit:10,type:"minutes"},{value:"15m",name:"15 Minutes",digit:15,type:"minutes"},{value:"30m",name:"30 Minutes",digit:30,type:"minutes"},{value:"1h",name:"1 Hour",digit:1,type:"hours"},{value:"2h",name:"2 Hours",digit:2,type:"hours"},{value:"4h",name:"4 Hours",digit:4,type:"hours"},{value:"8h",name:"8 Hours",digit:8,type:"hours"},{value:"1d",name:"1 Day",digit:1,type:"days"}],u=[{value:"candlestick",name:"Candles"},{value:"ohlc",name:"OHLC"},{value:"line",name:"Line"},{value:"dot",name:"Dot"},{value:"linedot",name:"Line Dot"},{value:"spline",name:"Spline"},{value:"table",name:"Table"}];return i18n_name=(local_storage.get("i18n")||{value:"en"}).value,appURL=getAppURL(),urlShareTemplate=appURL+"?affiliates=true&instrument={0}&timePeriod={1}&lang="+i18n_name,iframeShareTemplate='<iframe src="'+urlShareTemplate+'" width="350" height="400" style="overflow-y : hidden;" scrolling="no" />',twitterShareTemplate="https://twitter.com/share?url={0}&text={1}",fbShareTemplate="https://facebook.com/sharer/sharer.php?u={0}",gPlusShareTemplate="https://plus.google.com/share?url={0}",bloggerShareTemplate="https://www.blogger.com/blog-this.g?u={0}&n={1}",vkShareTemplate="http://vk.com/share.php?url={0}&title={1}",{init:function(d,f,r,v,w,x,y,z){require(["text!charts/chartOptions.html","css!charts/chartOptions.css"],function(A){m(w),p[d]&&p[d].unbind(),o[d]={newTabId:d,timePeriod:t.filter(function(a){return f==a.value})[0],timeperiod_arr:t,chartType:u.filter(function(a){return a.value==r})[0],tableViewCallback:v,instrumentName:w,instrumentCode:x,indicatorsCount:0,overlayCount:0,showTimePeriodSelector:!1,showChartTypeSelector:!1,showTableOption:!0,enableCrosshair:!0,showDrawingToolSelector:!1,showExportSelector:!1,showLoadSaveSelector:!1,showShare:"undefined"==typeof y?!0:y,showOverlay:"undefined"==typeof z?!0:z,showInstrumentName:!1,exportChartURLShare:urlShareTemplate.format(x,f),exportChartIframeShare:iframeShareTemplate.format(x,f),fbShareLink:fbShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f))),twitterShareLink:twitterShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f)),w+"("+f+")"),gPlusShareLink:gPlusShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f))),bloggerShareLink:bloggerShareTemplate.format(urlShareTemplate.format(x,f),w+"("+f+")"),vkShareLink:vkShareTemplate.format(urlShareTemplate.format(x,f),w+"("+f+")")},p[d]=null,o[d].toggleTimerPeriodSelector=function(a,b){var c=!b.showTimePeriodSelector;h(b),b.showTimePeriodSelector=c,a.originalEvent.scope=b.newTabId},o[d].toggleChartTypeSelector=function(b,c){var d=!c.showChartTypeSelector,e=a("#"+c.newTabId+" .chart_type .img span")[0];1==d&&b?(h(c),c.showChartTypeSelector=d,n(e,!0),b.originalEvent.scope=c.newTabId):(c.showChartTypeSelector=!1,n(e,!1))},o[d].addRemoveIndicator=function(a,b){require(["charts/indicators/indicatorManagement"],function(a){var c=b.instrumentName+" ("+b.timePeriod.value+")";a.openDialog("#"+b.newTabId+"_chart",c)})},o[d].addRemoveOverlay=function(a,b){require(["charts/overlay/overlayManagement"],function(a){var c=b.instrumentName+" ("+b.timePeriod.value+")";a.openDialog("#"+b.newTabId+"_chart",c)})},o[d].changeChartType=function(b,c){var d=a(b.target).attr("data-charttype");d&&i(c,d)},o[d].changeTimePeriod=function(b,c){var h=b.target.dataset.timeperiod;if(h){c=o[c.newTabId],g.unregister(g.keyFor(c.instrumentCode,c.timePeriod.value),"#"+c.newTabId+"_chart"),c.timePeriod=t.filter(function(a){return h==a.value})[0],l(c,a("#"+c.newTabId).find(".chart-view"));var m=isTick(h);!m||"candlestick"!==c.chartType.value&&"ohlc"!==c.chartType.value||i(c,"line"),k(c.newTabId,!m&&!j("#"+d+"_chart")),e.refresh("#"+c.newTabId+"_chart",h,c.chartType.value),c.exportChartURLShare=urlShareTemplate.format(c.instrumentCode,h),c.exportChartIframeShare=iframeShareTemplate.format(c.instrumentCode,h),c.fbShareLink=fbShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f))),c.twitterShareLink=twitterShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f)),w+"("+f+")"),c.gPlusShareLink=gPlusShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f))),c.bloggerShareLink=bloggerShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f)),w+"("+f+")"),c.vkShareLink=vkShareTemplate.format(encodeURIComponent(urlShareTemplate.format(x,f)),w+"("+f+")"),a("#"+c.newTabId).trigger("chart-time-period-changed",h)}},k(d,!isTick(f)&&!j("#"+d+"_chart")),v||(o[d].showTableOption=!1),o[d].toggleCrosshair=function(a,b){b.enableCrosshair=!b.enableCrosshair,require(["charts/crosshair"],function(a){a.toggleCrossHair("#"+b.newTabId+"_chart")})},o[d].toggleDrawingToolSelector=function(b,c){var d=!c.showDrawingToolSelector,e=a("#"+c.newTabId+" .drawButton .img span")[0];1==d&&b?(h(c),c.showDrawingToolSelector=d,n(e,!0),b.originalEvent.scope=c.newTabId):(c.showDrawingToolSelector=!1,n(e,!1))},o[d].addDrawingTool=function(b,c){var d=b.target.dataset.drawingtool;d&&require(["charts/draw/highcharts_custom/"+d],function(b){var d="#"+c.newTabId+"_chart";a(d).highcharts().annotate=!0,b.init(d)})},o[d].toggleExportSelector=function(b,c){var d=!c.showExportSelector,e=a("#"+c.newTabId+" .shareButton .img span")[0];1==d&&b?(h(c),c.showExportSelector=d,n(e,!0),b.originalEvent.scope=c.newTabId):(c.showExportSelector=!1,n(e,!1))},o[d].toggleLoadSaveSelector=function(b,c){var d=!c.showLoadSaveSelector,e=a("#"+c.newTabId+" .templateButton .img span")[0];1==d&&b?(h(c),c.showLoadSaveSelector=d,n(e,!0),b.originalEvent.scope=c.newTabId):(c.showLoadSaveSelector=!1,n(e,!1))},o[d]["export"]=function(b,c){var d=b.target.dataset.exporttype;if(d){var f="#"+c.newTabId+"_chart",g=a(f).highcharts();switch(d){case"png":g.exportChartLocal();break;case"pdf":g.exportChart({type:"application/pdf"});break;case"csv":e.generate_csv(g,a(f).data());break;case"svg":g.exportChartLocal({type:"image/svg+xml"})}}},a("#"+d).on("chart-indicators-changed",function(a,b){o[d].indicatorsCount=b.get_indicators().length}),o[d].overlayCount=a("#"+d+"_chart").data("overlayCount"),a("#"+d).on("chart-overlay-add",function(){var b=a("#"+d+"_chart").highcharts();o[d].overlayCount=b.get_overlay_count()}),a("#"+d).on("chart-overlay-remove",function(){var b=a("#"+d+"_chart").highcharts();o[d].overlayCount=b.get_overlay_count()}),isAffiliates()?a(window).resize(function(){l(o[d],a("#"+d).find(".chart-view"))}):a("#"+d).on("resize-event",function(){l(o[d],a(this).find(".chart-view"))}),!s&&a("body").on("click",function(a){c.forEach(Object.keys(o),function(b){a.originalEvent&&b!=a.originalEvent.scope&&h(o[b])})}),s=!0;var B=a(A).i18n();a("#"+d+"_header").prepend(B),b.formatters.filter=function(a,b){return a.filter(function(a){return a.type==b})},p[d]=b.bind(B[0],o[d]),require(["charts/chartTemplateManager"],function(a){var b=B.find(".chart-template-manager-root");q[d]=a.init(b,d)}),B.find(".loadSaveOverlay").on("click",function(a){a.stopPropagation()}),B.find(".exportOverlay").on("click",function(a){a.stopPropagation()}),l(o[d],a("#"+d).find(".chart-view"))})},updateOptions:function(b,c,d,e,f){var g=o[b];g&&(g.chartType=u.filter(function(a){return a.value==c})[0],g.timePeriod=t.filter(function(a){return d==a.value})[0],g.indicatorsCount=e,g.overlayCount=f,k(b,!isTick(d)&&f>0),l(g,a("#"+b).find(".chart-view")))},disableEnableCandlestickAndOHLC:function(a,b){o[a]&&k(a,b)},selectChartType:function(a,b,c){c?o[a].changeChartType(o[a],b):o[a].chartType=u.filter(function(a){return a.value==b})[0]},cleanBinding:function(a){p[a]&&(p[a].unbind(),q[a]&&q[a].unbind(),delete q[a],delete p[a],delete o[a])},setIndicatorsCount:function(a,b){o[b].indicatorsCount=a}}});